<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Safe Crossing: Real Traffic Edition</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial', sans-serif; background-color: #87CEEB; user-select: none; }
        
        /* --- HEADS UP DISPLAY (HUD) --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* Signal Indicator */
        .signal-box {
            align-self: flex-end;
            margin: 20px;
            background: #222;
            padding: 10px;
            border-radius: 10px;
            border: 3px solid white;
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .light { width: 60px; height: 60px; border-radius: 50%; background: #444; transition: 0.3s; }
        .light.red.active { background-color: #ff0000; box-shadow: 0 0 20px #ff0000; }
        .light.green.active { background-color: #00ff00; box-shadow: 0 0 20px #00ff00; }

        /* Instructions */
        .top-center {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 10px 30px;
            border-radius: 20px;
            color: white;
            border: 2px solid white;
        }
        #status-text { font-size: 24px; font-weight: bold; text-transform: uppercase; }

        /* Controls Guide */
        .controls-guide {
            align-self: center;
            margin-bottom: 40px;
            display: grid;
            grid-template-columns: 60px 60px 60px;
            gap: 10px;
            opacity: 0.8;
        }
        .key {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 30px;
            font-weight: bold;
        }
        .key-up { grid-column: 2; }
        .key-left { grid-column: 1; grid-row: 2; }
        .key-down { grid-column: 2; grid-row: 2; }
        .key-right { grid-column: 3; grid-row: 2; }
        .key.pressed { background: #4CAF50; transform: scale(0.95); }

        /* Start Screen */
        #start-screen, #game-over {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            pointer-events: auto;
        }
        #game-over { display: none; }
        
        .btn {
            background: #ffcc00; color: black; border: none;
            padding: 20px 50px; font-size: 24px; font-weight: bold;
            border-radius: 50px; cursor: pointer; margin-top: 20px;
            box-shadow: 0 5px 0 #b38f00;
            transition: 0.2s;
        }
        .btn:hover { transform: scale(1.1); }
        .btn:active { transform: translateY(4px); box-shadow: none; }

    </style>
</head>
<body>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1>ðŸš¦ Road Safety Hero</h1>
        <p>Watch the lights. Wait for Green. Cross Safely.</p>
        <button class="btn" onclick="startGame()">PLAY GAME</button>
    </div>

    <!-- Game Over Screen -->
    <div id="game-over">
        <h1 id="go-title">CRASH!</h1>
        <p id="go-msg">Always look before crossing.</p>
        <button class="btn" onclick="resetGame()">TRY AGAIN</button>
    </div>

    <!-- HUD -->
    <div id="ui-layer">
        <div class="top-center">
            <div id="status-text">WAIT</div>
        </div>

        <div class="controls-guide">
            <div id="k-up" class="key key-up">â¬†</div>
            <div id="k-left" class="key key-left">â¬…</div>
            <div id="k-down" class="key key-down">â¬‡</div>
            <div id="k-right" class="key key-right">âž¡</div>
        </div>

        <div class="signal-box">
            <div id="l-red" class="light red active"></div>
            <div id="l-green" class="light green"></div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        // --- GAME VARIABLES ---
        let scene, camera, renderer;
        let player, playerLegs = [], playerArms = [];
        let cars = [];
        let arrows = [];
        let isGameRunning = false;
        let signalState = "red"; 
        let keyState = {};
        let laneSpeeds = [0.12, 0.18, 0.10]; // Speed for 3 lanes
        let signalTimer;
        const CROSSING_TIME = 5000; 

        // --- AUDIO SYSTEM (Simple) ---
        const AudioSys = {
            ctx: null,
            init: function() {
                this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            },
            beep: function(freq, type) {
                if(!this.ctx) return;
                const o = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                o.type = type; o.frequency.value = freq;
                g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.5);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime + 0.5);
            },
            engine: function() { /* Simulated in logic for simplicity */ }
        };

        // --- INIT ---
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            AudioSys.init();
            if (!scene) init3D();
            resetGame();
        }

        function init3D() {
            // Scene Setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 8, 12);
            camera.lookAt(0, 0, 1);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lights
            const amb = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(amb);
            const sun = new THREE.DirectionalLight(0xffffff, 0.9);
            sun.position.set(10, 20, 10);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 1024;
            sun.shadow.mapSize.height = 1024;
            scene.add(sun);

            buildEnvironment();
            createPlayer();
            
            // Input
            window.addEventListener('keydown', (e) => {
                keyState[e.code] = true;
                highlightKey(e.code, true);
            });
            window.addEventListener('keyup', (e) => {
                keyState[e.code] = false;
                highlightKey(e.code, false);
            });
            window.addEventListener('resize', onResize);

            animate();
        }

        // --- BUILDERS ---

        function buildEnvironment() {
            // Grass
            const grass = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x4CAF50 }));
            grass.rotation.x = -Math.PI / 2;
            grass.receiveShadow = true;
            scene.add(grass);

            // Road (Asphalt)
            const road = new THREE.Mesh(new THREE.PlaneGeometry(100, 9), new THREE.MeshStandardMaterial({ color: 0x333333 }));
            road.rotation.x = -Math.PI / 2;
            road.position.y = 0.02;
            road.receiveShadow = true;
            scene.add(road);

            // Zebra Crossing
            const zebraGroup = new THREE.Group();
            for(let i=-2; i<=2; i++) {
                const stripe = new THREE.Mesh(new THREE.PlaneGeometry(1, 9), new THREE.MeshBasicMaterial({ color: 0xffffff }));
                stripe.rotation.x = -Math.PI / 2;
                stripe.position.set(i * 1.8, 0.03, 0);
                zebraGroup.add(stripe);
            }
            scene.add(zebraGroup);

            // Road Arrows (Guides)
            const arrowMat = new THREE.MeshBasicMaterial({ color: 0xffff00, transparent: true, opacity: 0.6 });
            const arrowGeo = new THREE.ConeGeometry(0.5, 1, 32);
            
            // Lane 1 Arrow (Left)
            let a1 = new THREE.Mesh(arrowGeo, arrowMat);
            a1.rotation.z = Math.PI / 2;
            a1.position.set(-8, 0.1, -3);
            scene.add(a1);

            // Lane 2 Arrow (Right)
            let a2 = new THREE.Mesh(arrowGeo, arrowMat);
            a2.rotation.z = -Math.PI / 2;
            a2.position.set(8, 0.1, 0);
            scene.add(a2);

            // Lane 3 Arrow (Left)
            let a3 = new THREE.Mesh(arrowGeo, arrowMat);
            a3.rotation.z = Math.PI / 2;
            a3.position.set(-8, 0.1, 3);
            scene.add(a3);
        }

        function createPlayer() {
            const kid = new THREE.Group();

            // Materials
            const skinMat = new THREE.MeshStandardMaterial({ color: 0xffccaa });
            const shirtMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const pantsMat = new THREE.MeshStandardMaterial({ color: 0x0000ff });

            // Head
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), skinMat);
            head.position.y = 1.6;
            kid.add(head);

            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.7, 0.3), shirtMat);
            body.position.y = 1.0;
            kid.add(body);

            // Legs (Animated)
            const legGeo = new THREE.BoxGeometry(0.2, 0.7, 0.25);
            const leftLeg = new THREE.Mesh(legGeo, pantsMat);
            leftLeg.position.set(-0.15, 0.35, 0);
            kid.add(leftLeg);
            playerLegs.push(leftLeg);

            const rightLeg = new THREE.Mesh(legGeo, pantsMat);
            rightLeg.position.set(0.15, 0.35, 0);
            kid.add(rightLeg);
            playerLegs.push(rightLeg);

            kid.castShadow = true;
            player = kid;
            scene.add(player);
        }

        function spawnVehicle(type, zPos, direction) {
            const vehicle = new THREE.Group();
            let mainColor, bodyGeo;

            // Wheels helper
            const addWheels = (xOffset, zOffset) => {
                const wGeo = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 16);
                const wMat = new THREE.MeshStandardMaterial({ color: 0x111111 });
                wGeo.rotateX(Math.PI/2);
                
                const w1 = new THREE.Mesh(wGeo, wMat); w1.position.set(xOffset, 0.3, zOffset);
                const w2 = new THREE.Mesh(wGeo, wMat); w2.position.set(xOffset, 0.3, -zOffset);
                vehicle.add(w1); vehicle.add(w2);
            };

            if (type === 'car') {
                // Sports Car
                const chassis = new THREE.Mesh(new THREE.BoxGeometry(2.5, 0.5, 1.2), new THREE.MeshStandardMaterial({color: 0xe74c3c}));
                chassis.position.y = 0.6;
                const top = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.4, 1), new THREE.MeshStandardMaterial({color: 0xffffff}));
                top.position.set(-0.2, 1.0, 0);
                vehicle.add(chassis); vehicle.add(top);
                addWheels(-0.8, 0.6); addWheels(0.8, 0.6);
            } 
            else if (type === 'bus') {
                // School Bus
                const body = new THREE.Mesh(new THREE.BoxGeometry(4.5, 1.4, 1.3), new THREE.MeshStandardMaterial({color: 0xf1c40f}));
                body.position.y = 1.0;
                // Windows
                const win = new THREE.Mesh(new THREE.BoxGeometry(4.6, 0.4, 1.35), new THREE.MeshStandardMaterial({color: 0x333333}));
                win.position.y = 1.2;
                vehicle.add(body); vehicle.add(win);
                addWheels(-1.5, 0.6); addWheels(1.5, 0.6);
            }
            else if (type === 'truck') {
                // Truck
                const cab = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.2, 1.3), new THREE.MeshStandardMaterial({color: 0x3498db}));
                cab.position.set(1.2, 0.9, 0);
                const trailer = new THREE.Mesh(new THREE.BoxGeometry(3.5, 1.5, 1.4), new THREE.MeshStandardMaterial({color: 0xecf0f1}));
                trailer.position.set(-1.4, 1.1, 0);
                vehicle.add(cab); vehicle.add(trailer);
                addWheels(1.2, 0.6); addWheels(-0.5, 0.6); addWheels(-2.5, 0.6);
            }

            vehicle.position.set(direction === 1 ? -20 : 20, 0, zPos);
            vehicle.userData = { speed: 0, direction: direction, type: type };
            scene.add(vehicle);
            cars.push(vehicle);
        }

        function setupTraffic() {
            // Clear old cars
            cars.forEach(c => scene.remove(c));
            cars = [];

            // Lane 1 (Z: -3) - Left to Right - CARS
            spawnVehicle('car', -3, 1);
            setTimeout(() => spawnVehicle('car', -3, 1), 2000);

            // Lane 2 (Z: 0) - Right to Left - BUS
            spawnVehicle('bus', 0, -1);
            
            // Lane 3 (Z: 3) - Left to Right - TRUCK
            spawnVehicle('truck', 3, 1);
        }

        // --- GAME LOGIC ---

        function updateSignal() {
            if (!isGameRunning) return;
            
            const redLight = document.getElementById('l-red');
            const greenLight = document.getElementById('l-green');
            const status = document.getElementById('status-text');

            if (signalState === 'red') {
                signalState = 'green'; // Green for PEDESTRIAN
                redLight.classList.remove('active');
                greenLight.classList.add('active');
                status.innerText = "GO! (Safe)";
                status.style.color = "#00ff00";
                AudioSys.beep(800, 'sine'); // Ding!
            } else {
                signalState = 'red'; // Red for PEDESTRIAN
                greenLight.classList.remove('active');
                redLight.classList.add('active');
                status.innerText = "WAIT! (Cars Moving)";
                status.style.color = "#ff0000";
                AudioSys.beep(300, 'square'); // Boop!
            }
        }

        function highlightKey(code, active) {
            const map = { 'ArrowUp': 'k-up', 'ArrowDown': 'k-down', 'ArrowLeft': 'k-left', 'ArrowRight': 'k-right' };
            if(map[code]) {
                const el = document.getElementById(map[code]);
                if(active) el.classList.add('pressed');
                else el.classList.remove('pressed');
            }
        }

        function resetGame() {
            isGameRunning = true;
            player.position.set(0, 0, 7); // Start
            player.rotation.y = Math.PI;
            
            signalState = 'red'; // Start on Red (Wait)
            document.getElementById('l-red').classList.add('active');
            document.getElementById('l-green').classList.remove('active');
            document.getElementById('status-text').innerText = "WAIT";
            document.getElementById('status-text').style.color = "red";
            
            document.getElementById('game-over').style.display = 'none';
            
            setupTraffic();
            
            clearInterval(signalTimer);
            signalTimer = setInterval(updateSignal, CROSSING_TIME);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.01;

            // --- PLAYER MOVEMENT & ANIMATION ---
            let isMoving = false;
            if (isGameRunning) {
                const speed = 0.1;
                if (keyState['ArrowUp']) { player.position.z -= speed; player.rotation.y = Math.PI; isMoving = true; }
                if (keyState['ArrowDown']) { player.position.z += speed; player.rotation.y = 0; isMoving = true; }
                if (keyState['ArrowLeft']) { player.position.x -= speed; player.rotation.y = -Math.PI/2; isMoving = true; }
                if (keyState['ArrowRight']) { player.position.x += speed; player.rotation.y = Math.PI/2; isMoving = true; }

                // Walking Animation (Swing Legs)
                if (isMoving) {
                    playerLegs[0].rotation.x = Math.sin(time) * 0.5;
                    playerLegs[1].rotation.x = Math.sin(time + Math.PI) * 0.5;
                } else {
                    playerLegs[0].rotation.x = 0;
                    playerLegs[1].rotation.x = 0;
                }
            }

            // --- TRAFFIC LOGIC ---
            cars.forEach(car => {
                // Speed Logic: If Pedestrian Signal is RED, Cars Move. If Green, Cars Stop.
                let targetSpeed = (signalState === 'red') ? 0.15 : 0;
                
                // Interpolate speed for smoothness
                car.userData.speed += (targetSpeed - car.userData.speed) * 0.1;
                
                car.position.x += car.userData.speed * car.userData.direction;

                // Loop logic
                if (car.position.x > 25 && car.userData.direction === 1) car.position.x = -25;
                if (car.position.x < -25 && car.userData.direction === -1) car.position.x = 25;

                // Collision
                const pBox = new THREE.Box3().setFromObject(player);
                const cBox = new THREE.Box3().setFromObject(car);
                // Shrink collision box slightly to be forgiving
                cBox.expandByScalar(-0.2);

                if (pBox.intersectsBox(cBox)) {
                    gameOver();
                }
            });

            // --- WIN CONDITION ---
            if (player.position.z < -6 && isGameRunning) {
                winGame();
            }

            renderer.render(scene, camera);
        }

        function gameOver() {
            isGameRunning = false;
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('go-title').innerText = "OH NO!";
            document.getElementById('go-msg').innerText = "You hit a vehicle. Wait for Green!";
        }

        function winGame() {
            isGameRunning = false;
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('go-title').innerText = "YOU DID IT! ðŸŽ‰";
            document.getElementById('go-msg').innerText = "Great job crossing safely!";
            AudioSys.beep(600, 'sine');
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

    </script>
</body>
</html>
